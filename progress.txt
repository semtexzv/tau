# Progress Log

## Learnings
(Patterns discovered during implementation)

---

## Iteration 1 - US-001: Project scaffolding and dependencies
- What was done: Initialized Cargo lib project, set up all dependencies (crossterm with event-stream, unicode-width, unicode-segmentation, tokio, futures), created module structure with placeholder comments.
- Files changed: Cargo.toml, src/lib.rs, src/terminal.rs, src/utils.rs, src/component.rs, src/tui.rs, src/components/mod.rs
- Learnings for future iterations:
  - crossterm 0.28.1 resolved (0.29.0 available but PRD specifies 0.28)
  - unicode-segmentation resolved to 1.12.0 (compatible with specified 1.11)
  - All 56 dependency packages lock cleanly
  - cargo check and cargo test both pass with zero warnings
## Task self-review PASSED
---

## Iteration 2 - US-002: Terminal trait and CrosstermTerminal
- What was done: Implemented Terminal trait with 7 methods (start, stop, write, flush, size, hide_cursor, show_cursor), CrosstermTerminal using crossterm, and MockTerminal capturing writes to Vec<String>. Wrote 9 tests covering construction, writes, start/stop, cursor visibility, size, flush, and object safety.
- Files changed: src/terminal.rs, PRD.md
- Learnings for future iterations:
  - Terminal trait is object-safe — can use `Box<dyn Terminal>` (verified with test)
  - MockTerminal has public fields (writes, started, stopped, cursor_visible) for direct test assertions
  - MockTerminal.output() concatenates all writes for full output inspection
  - MockTerminal.set_size() allows simulating resize in tests
  - crossterm::terminal::size() may fail in test/CI environments — fallback to (80, 24)
  - Event reading is NOT on the trait — crossterm's EventStream used directly by TUI run loop
## Task self-review PASSED
---

## Iteration 3 - US-003: ANSI escape code utilities
- What was done: Verified existing implementation of strip_ansi and extract_ansi_code in src/utils.rs. All acceptance criteria already met — functions correctly handle CSI, OSC, and APC sequences. 24 tests covering normal paths, edge cases (unterminated sequences, bare ESC, out of bounds), and Unicode. Marked PRD criteria complete and committed.
- Files changed: PRD.md (acceptance criteria marked [x])
- Learnings for future iterations:
  - utils.rs already had full implementation from a prior session — always check existing code before writing new
  - extract_ansi_code works on byte offsets, not char offsets — callers must pass byte positions
  - OSC and APC share extract_string_sequence helper — both terminated by BEL or ST (ESC \)
  - CSI parsing follows ECMA-48: param bytes (0x30-0x3F), intermediate bytes (0x20-0x2F), final byte (0x40-0x7E)
  - strip_ansi delegates to extract_ansi_code for consistent parsing
## Task self-review PASSED
---

## Iteration 4 - US-004: Visible width calculation
- What was done: Implemented `visible_width()` and `truncate_to_width()` in src/utils.rs. Added 18 new tests covering ASCII, ANSI, wide chars, tabs, truncation with ellipsis, ANSI preservation, wide char truncation, edge cases (empty string, max_width < ellipsis width, empty ellipsis).
- Files changed: src/utils.rs, PRD.md
- Learnings for future iterations:
  - `visible_width` strips ANSI first via `strip_ansi`, then sums per-char widths with `UnicodeWidthStr::width` on 1-char slices
  - `truncate_to_width` walks bytes manually, passing through ANSI codes and counting grapheme widths — this pattern (byte-walking with ANSI passthrough) will recur in `wrap_text_with_ansi` (US-010)
  - Tab = 3 spaces convention from pi-mono
  - `unicode_segmentation::UnicodeSegmentation` used for grapheme-aware truncation
  - `saturating_sub` handles edge case where ellipsis is wider than max_width
## Task self-review PASSED
---

## Iteration 5 - US-005: Component trait and Container
- What was done: Implemented `Component` trait (render required, handle_input + invalidate with defaults) and `Container` struct (Vec<Box<dyn Component>>, add_child, remove_child, clear, render concatenation, invalidate propagation). Wrote 11 tests including empty container, concatenation, remove/clear, default/len/is_empty, invalidation, empty child, trait defaults, and object safety.
- Files changed: src/component.rs, PRD.md
- Learnings for future iterations:
  - Component trait is object-safe — `Box<dyn Component>` works (verified with test)
  - Container.render() simply extends a Vec from each child — no special casing needed
  - Can't inspect trait object internals through Box<dyn Component> (e.g., can't check MockComponent.invalidated) — design tests around observable behavior instead
  - `Default` impl provided for Container (Clippy will want this if `new()` exists)
  - Container also exposes `len()` and `is_empty()` for convenience
## Task self-review PASSED
---
